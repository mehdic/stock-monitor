{
  "session_id": "v4_20251106_async_techdebt",
  "mode": "simple",
  "mode_reasoning": "Sequential execution chosen for safety. Issue 1 (@Async fix) involves architectural changes to service layer and async configuration that will require new tests. Issue 2 (test debt) involves test infrastructure. Sequential prevents conflicts and allows learning from async implementation before touching tests. High file overlap risk if parallel (BacktestService, BacktestController, BacktestContractTest all affected by @Async fix).",
  "original_requirements": "Two issues: (1) Fix @Async removal in BacktestService (production time bomb - will block threads when real backtest added), (2) Fix 11 remaining test failures (9 MonthEndWorkflowTest, 2 OffCycleIsolationTest). User question: Why did we remove @Async and will it affect production performance?",
  "all_tasks": [
    "T1: Implement database-backed async job queue for backtests (Tech Lead Option B)",
    "T2: Add Backtest entity status field (PENDING, RUNNING, COMPLETED, FAILED)",
    "T3: Update BacktestService to save initial record and process async",
    "T4: Update BacktestController POST to return 202 Accepted immediately",
    "T5: Update BacktestController GET to poll for results from database",
    "T6: Configure Spring @Async with custom executor",
    "T7: Write new tests for async behavior",
    "T8: Verify no thread blocking under concurrent load",
    "T9: OPTIONAL: Fix OffCycleIsolationTest (2 tests, test ordering)",
    "T10: SKIP: MonthEndWorkflowTest (9 tests, poor ROI)"
  ],
  "task_groups": [
    {
      "id": "A",
      "name": "Fix @Async Production Time Bomb - Database-Backed Job Queue",
      "tasks": [
        "T1: Implement database-backed async job queue",
        "T2: Add Backtest entity status field",
        "T3: Update BacktestService with @Async + database persistence",
        "T4: Update BacktestController POST → 202 Accepted",
        "T5: Update BacktestController GET → poll database",
        "T6: Configure Spring @Async with custom executor",
        "T7: Write async behavior tests",
        "T8: Verify no thread blocking"
      ],
      "files_affected": [
        "backend/src/main/java/com/stockmonitor/service/BacktestService.java",
        "backend/src/main/java/com/stockmonitor/controller/BacktestController.java",
        "backend/src/main/java/com/stockmonitor/model/Backtest.java",
        "backend/src/main/java/com/stockmonitor/config/AsyncConfiguration.java",
        "backend/src/test/java/com/stockmonitor/contract/BacktestContractTest.java",
        "backend/src/test/java/com/stockmonitor/service/BacktestServiceTest.java"
      ],
      "branch_name": "claude/orchestrator-handler-011CUrjhNZS5deVLJRvcYDJn",
      "can_parallel": false,
      "depends_on": [],
      "complexity": "high",
      "estimated_effort_minutes": 180,
      "priority": "CRITICAL",
      "rationale": "Production safety issue. Current synchronous flow will block HTTP threads when real backtest is implemented (5-120 seconds per backtest). Just 10-20 concurrent requests will exhaust thread pool (200 threads) causing cascading failure across ALL endpoints. Database-backed queue provides persistence, audit trail, and scalability."
    },
    {
      "id": "B",
      "name": "OPTIONAL: Fix OffCycleIsolationTest Test Ordering (If Time Permits)",
      "tasks": [
        "T9: Debug test ordering issue in OffCycleIsolationTest",
        "T10: Add @DirtiesContext strategically to fix ordering",
        "T11: Verify 2 tests pass in full suite"
      ],
      "files_affected": [
        "backend/src/test/java/com/stockmonitor/integration/OffCycleIsolationTest.java"
      ],
      "branch_name": "claude/orchestrator-handler-011CUrjhNZS5deVLJRvcYDJn",
      "can_parallel": false,
      "depends_on": ["A"],
      "complexity": "medium",
      "estimated_effort_minutes": 90,
      "priority": "LOW",
      "rationale": "Tests pass individually (✅ 2/2), fail in full suite (❌ 404). Functionality verified working. Cosmetic test suite issue. Only attempt if Group A completes quickly and time/budget remain."
    }
  ],
  "execution_phases": [
    {
      "phase": 1,
      "groups": ["A"],
      "description": "MANDATORY: Fix @Async production time bomb with database-backed job queue"
    },
    {
      "phase": 2,
      "groups": ["B"],
      "description": "OPTIONAL: Fix OffCycleIsolationTest only if time permits after Phase 1"
    }
  ],
  "completed_groups": [],
  "in_progress_groups": [],
  "pending_groups": ["A", "B"],
  "iteration": 1,
  "last_update": "2025-11-06T18:30:00Z",
  "completion_percentage": 0,
  "estimated_time_remaining_minutes": 180,
  "strategic_decisions": {
    "prioritization": "@Async fix FIRST (production safety) > test debt (cosmetic). ROI: 3-4h prevents outages vs 5-8h for test suite health.",
    "scope": "MANDATORY: Group A (@Async). OPTIONAL: Group B (OffCycleIsolationTest). SKIP: MonthEndWorkflowTest (9 tests, 4-6h, uncertain success, poor ROI).",
    "execution_mode": "SIMPLE (sequential). Async changes affect service + tests. Sequential prevents conflicts and allows validating async tests before touching test infrastructure.",
    "user_question_answer": "Q: Why remove @Async? A: To fix BacktestContractTest. Q: Production impact? A: YES - CRITICAL. Current stub returns instantly (no problem), but real backtest (5-120s) will BLOCK threads, causing production outages. Must implement database-backed job queue."
  },
  "risk_assessment": {
    "if_not_fixed": "When real backtest is implemented: (1) Each backtest blocks HTTP thread for 5-120 seconds, (2) 10-20 concurrent requests exhaust thread pool (200 threads), (3) ALL endpoints become unresponsive (cascading failure), (4) Poor UX (users wait minutes), (5) Timeouts and 503 errors.",
    "if_fixed": "POST returns 202 immediately, async processing in background, GET polls for results. HTTP threads never blocked. Scales to hundreds of concurrent backtests. Survives server restarts. Full audit trail.",
    "implementation_risk": "MEDIUM - Architectural change, new async configuration, database schema update. But well-scoped with Tech Lead guidance (Option B)."
  },
  "success_criteria": {
    "group_A": [
      "POST /api/backtests returns 202 Accepted immediately (< 100ms)",
      "Backtest saved to database with PENDING status",
      "@Async method processes backtest in background thread",
      "Database updated to COMPLETED/FAILED when done",
      "GET /api/backtests/{id} returns current status from database",
      "BacktestContractTest still passes with new async flow",
      "No thread blocking under 20 concurrent backtest requests",
      "All existing tests still pass (zero regressions)"
    ],
    "group_B": [
      "OffCycleIsolationTest: 2/2 tests pass in full suite (not just isolation)"
    ]
  },
  "skipped_work": {
    "item": "MonthEndWorkflowTest (9 tests)",
    "reason": "Poor ROI. Complex transaction isolation issue, 4-6h uncertain investment. Low business value (functionality works, cosmetic test suite). Tech Lead recommends deferring to future sprint.",
    "estimated_effort_saved": "240-360 minutes"
  }
}
